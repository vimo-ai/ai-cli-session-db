# ai-cli-session-db Release CI
#
# Triggered on tag push (v*)
# Builds for macOS arm64:
#   - libai_cli_session_db.dylib (FFI library)
#   - vimo-agent (Agent binary)
# Uploads to GitHub Release with sha256 checksums

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (build only, no release)'
        type: boolean
        default: true

env:
  CARGO_TERM_COLOR: always

jobs:
  build-macos:
    runs-on: macos-14  # Apple Silicon runner
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Build release
        run: |
          # Build FFI dylib
          cargo build --release --features ffi,fts,client

          # Build vimo-agent binary
          cargo build --release --bin vimo-agent --features agent

      - name: Get dylib info
        id: dylib
        run: |
          DYLIB_PATH="target/release/libai_cli_session_db.dylib"

          # Get size
          SIZE=$(stat -f%z "$DYLIB_PATH")
          SIZE_MB=$(echo "scale=2; $SIZE / 1048576" | bc)

          # Get sha256
          SHA256=$(shasum -a 256 "$DYLIB_PATH" | cut -d' ' -f1)

          # Get version from tag
          VERSION=${GITHUB_REF#refs/tags/v}

          echo "path=$DYLIB_PATH" >> $GITHUB_OUTPUT
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "size_mb=$SIZE_MB" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          echo "### dylib Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Size**: ${SIZE_MB}MB" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA256**: \`$SHA256\`" >> $GITHUB_STEP_SUMMARY

      - name: Get agent info
        id: agent
        run: |
          AGENT_PATH="target/release/vimo-agent"

          # Get size
          SIZE=$(stat -f%z "$AGENT_PATH")
          SIZE_MB=$(echo "scale=2; $SIZE / 1048576" | bc)

          # Get sha256
          SHA256=$(shasum -a 256 "$AGENT_PATH" | cut -d' ' -f1)

          echo "path=$AGENT_PATH" >> $GITHUB_OUTPUT
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "size_mb=$SIZE_MB" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT

          echo "### vimo-agent Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Size**: ${SIZE_MB}MB" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA256**: \`$SHA256\`" >> $GITHUB_STEP_SUMMARY

      - name: Create checksum files
        run: |
          cd target/release
          shasum -a 256 libai_cli_session_db.dylib > libai_cli_session_db.dylib.sha256
          shasum -a 256 vimo-agent > vimo-agent.sha256

      - name: Sign binaries (ad-hoc)
        run: |
          codesign -f -s - target/release/libai_cli_session_db.dylib
          codesign -f -s - target/release/vimo-agent

      - name: Upload artifact (dry run)
        if: ${{ inputs.dry_run }}
        uses: actions/upload-artifact@v4
        with:
          name: ai-cli-session-db-release
          path: |
            target/release/libai_cli_session_db.dylib
            target/release/libai_cli_session_db.dylib.sha256
            target/release/vimo-agent
            target/release/vimo-agent.sha256
            include/ai_cli_session_db.h

      - name: Create Release
        if: ${{ !inputs.dry_run }}
        uses: softprops/action-gh-release@v2
        with:
          files: |
            target/release/libai_cli_session_db.dylib
            target/release/libai_cli_session_db.dylib.sha256
            target/release/vimo-agent
            target/release/vimo-agent.sha256
            include/ai_cli_session_db.h
          body: |
            ## ai-cli-session-db v${{ steps.dylib.outputs.version }}

            macOS arm64 发布包

            ### 产物

            | 文件 | 说明 | SHA256 |
            |------|------|--------|
            | `libai_cli_session_db.dylib` | FFI 动态库 | `${{ steps.dylib.outputs.sha256 }}` |
            | `vimo-agent` | Agent 二进制 | `${{ steps.agent.outputs.sha256 }}` |

            ### 安装 dylib

            ```bash
            mkdir -p ~/.vimo/lib
            curl -L -o ~/.vimo/lib/libai_cli_session_db.dylib \
              https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/libai_cli_session_db.dylib
            ```

            ### 安装 vimo-agent

            ```bash
            mkdir -p ~/.vimo/bin
            curl -L -o ~/.vimo/bin/vimo-agent \
              https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/vimo-agent
            chmod +x ~/.vimo/bin/vimo-agent
            ```
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
